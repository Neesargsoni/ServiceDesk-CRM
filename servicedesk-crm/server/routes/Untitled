// server/routes/TicketRoutes.js - AI ENHANCED VERSION
// Add this import at the top with your other imports
import { 
  classifyTicket, 
  analyzeSentiment, 
  suggestPriority, 
  calculateConfidence 
} from "../utils/aiClassifier.js";

// Replace your existing POST /create route with this:

/**
 * POST /api/tickets/create
 * ðŸ¤– AI-ENHANCED: Auto-classifies and analyzes sentiment
 */
router.post("/create", authMiddleware, async (req, res) => {
  try {
    const { title, description, priority } = req.body;
    if (!title || !description) 
      return res.status(400).json({ error: "Title and description are required" });

    console.log("ðŸŽ« Creating ticket with AI analysis...");

    // ðŸ¤– AI ANALYSIS (runs in parallel for speed)
    const [aiCategory, aiSentiment] = await Promise.all([
      classifyTicket(title, description),
      analyzeSentiment(description),
    ]);

    // Calculate AI-suggested priority
    const aiSuggestedPriority = suggestPriority(aiSentiment, aiCategory);
    
    // Calculate confidence score
    const aiConfidence = calculateConfidence(aiCategory, aiSentiment);

    // Use AI-suggested priority if user didn't specify
    const finalPriority = priority || aiSuggestedPriority;

    console.log("ðŸ¤– AI Results:", {
      category: aiCategory,
      sentiment: aiSentiment,
      suggestedPriority: aiSuggestedPriority,
      confidence: aiConfidence,
    });

    const ticket = new Ticket({
      user: req.user.id,
      title,
      description,
      priority: finalPriority,
      status: "Open",
      
      // AI fields
      aiCategory,
      aiSentiment,
      aiSuggestedPriority,
      aiConfidence,
      aiProcessed: true,
      aiProcessedAt: new Date(),
      
      activity: [{
        user: req.user.id,
        userName: req.user.name,
        action: "created",
        details: `Ticket created (AI: ${aiCategory}, ${aiSentiment})`,
        timestamp: new Date()
      }]
    });

    await ticket.save();
    
    // Populate for socket emission
    await ticket.populate("user", "name email role");

    // ðŸ”´ Emit real-time event
    emitTicketUpdate(req, "ticket_created", {
      ticket,
      message: `New ${aiCategory} ticket created: ${title}`,
      createdBy: req.user.name,
      aiInsights: {
        category: aiCategory,
        sentiment: aiSentiment,
        priority: aiSuggestedPriority,
      }
    });

    res.status(201).json({ 
      message: "Ticket created successfully", 
      ticket,
      aiInsights: {
        category: aiCategory,
        sentiment: aiSentiment,
        suggestedPriority: aiSuggestedPriority,
        confidence: aiConfidence,
      }
    });

  } catch (err) {
    console.error("POST /api/tickets/create error:", err);
    res.status(500).json({ error: "Server error creating ticket" });
  }
});

// ADD THIS NEW ENDPOINT for Smart Replies
/**
 * POST /api/tickets/:id/smart-replies
 * ðŸ¤– Generate AI-powered reply suggestions
 */
router.post("/:id/smart-replies", agentOrAdmin, async (req, res) => {
  try {
    const { id } = req.params;
    if (!isValidId(id)) return res.status(400).json({ error: "Invalid ticket id" });

    const ticket = await Ticket.findById(id)
      .populate("user", "name email")
      .populate("assignedTo", "name email");

    if (!ticket) return res.status(404).json({ error: "Ticket not found" });

    console.log("ðŸ¤– Generating smart replies for ticket:", id);

    const suggestions = await generateSmartReplies(ticket);

    res.json({
      ticketId: id,
      suggestions,
      generatedAt: new Date(),
    });

  } catch (err) {
    console.error("POST /api/tickets/:id/smart-replies error:", err);
    res.status(500).json({ error: "Server error generating replies" });
  }
});

// Export your router as usual
export default router;